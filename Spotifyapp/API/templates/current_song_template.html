<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Song</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="song-info" class="text-center mt-20">
        <h3 id="song-title" class="text-3xl mb-4">{{ song.title }} - {{ song.artist }}</h3>

        <!-- Vinyl Container with continuous spinning animation -->
        <div class="relative inline-block mb-10 animate-spin-fast">
            <div class="w-64 h-64 rounded-full bg-gradient-to-r from-gray-800 via-gray-700 to-gray-600 relative mx-auto">
                <!-- Album Cover in the center (spinning with the vinyl) -->
                <img id="album-cover" src="{{ song.album_cover }}" alt="Album Cover" class="w-44 h-44 rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-4 border-white object-cover scale-105">
            </div>
        </div>



        <!-- Song Info 
        <div class="text-xl mb-6">
            <p>Duration: {{ song.duration }} seconds</p>
            <p>Time: {{ song.time }} seconds</p>
        </div>-->

        <!-- Progress Bar -->
        <div id="progress-container" class="w-64 mx-auto mt-4">
            <input
            id="progress-bar"
            type="range"
            min="0"
            max="{{ song.duration }}"
            class="w-full h-2 bg-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            
            <div class="flex justify-between text-sm text-gray-600 mt-1">
                <span id="current-time">0:00</span>
                <span id="total-time">{{ song.duration|date:"i:s" }}</span>
            </div>
        </div>
        

        <!-- Controls -->
        <div class="flex justify-center space-x-4">
            <button id="previous-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-lg">Previous</button>
            <button id="play-pause-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-lg" data-action="resume">Play</button>
            <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg text-lg" data-action="stop">Stop</button>
            <button id="skip-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg text-lg">Skip</button>
        </div>
    </div>

        </div>
    </div>

    <script>
        $(document).ready(function() {

            //Progress Bar
            const progressBar = document.getElementById("progress-bar");
            const currentTimeLabel = document.getElementById("current-time");
            const totalTimeLabel = document.getElementById("total-time");
            const songDuration = "{{ song.duration }}";
            const durationInMs = parseInt(songDuration, 10);
            const songTitle = document.getElementById("song-title");
            const albumCover = document.getElementById("album-cover");
            //console.log("Parsed Duration:", durationInMs);
            let currentSongTitle = sessionStorage.getItem("currentSongTitle") || "";
            let interval;

            // Function to format milliseconds to mm:ss
            function formatTime(ms) {
                const minutes = Math.floor(ms / 60000);
                const seconds = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
                return `${minutes}:${seconds}`;
            }

            // Update progress bar and time labels periodically

            function updateProgressBar() {
                const progressBar = document.getElementById("progress-bar");
                //console.log(progressBar);
                const key = "{{ user_key }}"; // Ensure this is passed correctly from Django

                fetch(`/spotify/current-song?key=${key}`, {
                    method: "GET",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        //console.log(data);
                        const currentPosition = data.time;
                        const songDuration = data.duration;

                        // Dynamically set the max value of the progress bar if it's not set yet
                        if (progressBar.max !== songDuration) {
                            progressBar.max = songDuration;
                        }

                        // Set the current progress
                        progressBar.value = (currentPosition);
                        //console.log(progressBar.value)
                        // Optionally update time labels
                        const currentTimeLabel = document.getElementById("current-time");
                        currentTimeLabel.textContent = formatTime(currentPosition);
                    })
                    .catch((error) => {
                        console.error("Error updating progress bar:", error);
                    });
            }


            // Seek to a specific position in the song
            progressBar.addEventListener("change", function () {
                console.log("AAAAAAAAAAAAA");
                const newPosition = progressBar.value;
                console.log(newPosition);
                $.ajax({
                    url: "/spotify/controls/", // SpotifyControls endpoint
                    type: "POST",
                    data: {
                        key: "{{ user_key }}", // Pass the session key
                        action: "seek",
                        position: newPosition,
                    },
                    success: function () {
                        updateProgressBar(); // Ensure progress bar syncs after seeking
                    },
                });
            });

            // Start the interval to update the progress bar
            interval = setInterval(updateProgressBar, 1000); // Update every second


            // Clean up interval on page unload
            window.addEventListener("beforeunload", () => clearInterval(interval));

            
            // Function to fetch song info
            function fetchSongInfo() {
                const key = "{{ user_key }}"; // Ensure this is passed correctly from Django

                fetch(`/spotify/current-song?key=${key}`, {
                    method: "GET",
                    headers: { "X-Requested-With": "XMLHttpRequest" },
                })
                    .then((response) => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then((data) => {
                        // Check if the song title has changed
                        console.log(data.title);
                        console.log(currentSongTitle);
                        if (data.title !== currentSongTitle) {
                            // Update stored title in sessionStorage
                            console.log("A ALTERAR");
                            
                            currentSongTitle = data.title;
                            sessionStorage.setItem("currentSongTitle", currentSongTitle);

                            // Update song title and album cover in the DOM
                            songTitle.textContent = `${data.title} - ${data.artist}`;
                        } else if (!songTitle) {
                            console.error("Elemento 'song-title' não encontrado no DOM.");
                        }

                        if (albumCover) {
                            albumCover.src = data.album_cover;
                        } else {
                            console.error("Elemento 'album-cover' não encontrado no DOM.");
                        }

                        // Log the update for debugging purposes
                        console.log(`Updated to new song: ${data.title}`);

                        // Update the progress bar and current time
                        progressBar.max = data.duration;
                        progressBar.value = data.time;
                        currentTimeLabel.textContent = formatTime(data.time);
                    })
                    .catch((error) => {
                        console.error("Error fetching song info:", error);
                    });
            }

            // Periodically fetch song info 
            setInterval(fetchSongInfo, 1000);


            // Skip Button
            $("#skip-btn").click(function() {
                var key = "{{ user_key }}";  // Pass the key value from the template

                $.ajax({
                    url: "/spotify/controls/",  // URL for skip action
                    type: "POST",
                    data: {
                        key: key,
                        action: "skip",  // Add action for skipping to next song
                    },
                    success: function(response) {
                        console.log("Skipped to next song:", response);
                        // Optionally update UI to reflect the new song
                    },
                    error: function(response) {
                        console.error("Skip action failed:", response);
                    }
                });
            });
            
            $("#previous-btn").click(function() {
                var key = "{{ user_key }}";  // Pass the key value from the template

                $.ajax({
                    url: "/spotify/controls/",  // URL for previous action
                    type: "POST",
                    data: {
                        key: key,
                        action: "previous",  // Add action for going back to previous song
                    },
                    success: function(response) {
                        console.log("Went to previous song:", response);
                        // Optionally update UI to reflect the new song
                    },
                    error: function(response) {
                        console.error("Previous action failed:", response);
                    }
                });
            });

            // Play/Pause button
            $("#play-pause-btn").click(function() {
                var action = $(this).data("action");
                var key = "{{ user_key }}";  // Pass the key value from the template

                $.ajax({
                    url: "/spotify/controls/",  // URL of the SpotifyControls view
                    type: "POST",
                    data: {
                        key: key,
                        action: action,
                    },
                    success: function(response) {
                        console.log("Action successful:", response);
                        // Toggle button text based on action
                        if (action === "resume") {
                            $("#play-pause-btn").data("action", "stop").text("Pause");
                        } else {
                            $("#play-pause-btn").data("action", "resume").text("Play");
                        }
                    },
                    error: function(response) {
                        console.error("Action failed:", response);
                    }
                });
            });

            // Stop button
            $("#stop-btn").click(function() {
                var action = $(this).data("action");
                var key = "{{ user_key }}";  // Pass the key value from the template

                $.ajax({
                    url: "/spotify/controls/",  // URL of the SpotifyControls view
                    type: "POST",
                    data: {
                        key: key,
                        action: action,
                    },
                    success: function(response) {
                        console.log("Action successful:", response);
                        // Disable the stop button after it's clicked
                        $("#stop-btn").prop("disabled", true);
                        
                    },
                    error: function(response) {
                        console.error("Action failed:", response);
                    }
                });
            });
        });
    </script>

    <style>
        /* Tailwind Custom continuous animation for fast spinning */
        @keyframes spin-fast {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Apply the animation */
        .animate-spin-fast {
            animation: spin-fast 7s linear infinite; /* time to do a whole spin */
        }
    </style>

</body>
</html>
