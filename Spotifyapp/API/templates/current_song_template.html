<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Current Song</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-white font-sans">

    <div id="song-info" class="text-center mt-20">
        <h3 id="song-title" class="text-3xl mb-4">{{ song.title }} - {{ song.artist }}</h3>

        <!-- Vinyl Container with continuous spinning animation -->
        <div class="relative inline-block mb-10 animate-spin-fast">
            <div class="w-64 h-64 rounded-full bg-gradient-to-r from-gray-800 via-gray-700 to-gray-600 relative mx-auto">
                <!-- Album Cover in the center (spinning with the vinyl) -->
                <img id="album-cover" src="{{ song.album_cover }}" alt="Album Cover" class="w-44 h-44 rounded-full absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 border-4 border-white object-cover scale-105">
            </div>
        </div>



        <!-- Song Info 
        <div class="text-xl mb-6">
            <p>Duration: {{ song.duration }} seconds</p>
            <p>Time: {{ song.time }} seconds</p>
        </div>-->

        <!-- Progress Bar -->
        <div id="progress-container" class="w-64 mx-auto mt-4">
            <input
            id="progress-bar"
            type="range"
            min="0"
            max="{{ song.duration }}"
            class="w-full h-2 bg-gray-300 rounded-lg appearance-none focus:outline-none focus:ring-2 focus:ring-blue-500"/>
            
            <div class="flex justify-between text-sm text-gray-600 mt-1">
                <span id="current-time">0:00</span>
                <span id="total-time">{{ song.duration|date:"i:s" }}</span>
            </div>
        </div>
        

        <!-- Controls -->
        <div class="flex justify-center space-x-4">
            <button id="previous-btn" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg text-lg">Previous</button>
            <button id="play-pause-btn" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg text-lg" data-action="resume">Play</button>
            <button id="stop-btn" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg text-lg" data-action="stop">Stop</button>
            <button id="skip-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-3 rounded-lg text-lg">Skip</button>
        </div>
    </div>


        </div>

    </div>

    <!-- Heart Rate Section -->
<div id="heart-rate-section" class="mt-8 p-6 bg-gray-800 rounded-xl shadow-lg">
    <h3 class="text-2xl font-bold mb-4 text-center">Heart Rate Monitor</h3>

    <!-- Heart Rate Value with Animation -->
    <div class="flex justify-center items-center space-x-4">
        <div class="relative">
            <!-- Heart Icon Pulse -->
            <div id="heart-icon" class="text-red-500 text-8xl animate-pulse">❤️</div>
            <!-- BPM Value -->
            <div id="heart-rate-value" class="absolute inset-0 flex items-center justify-center text-white font-bold text-xl">
                -- BPM
            </div>
        </div>

        <!-- Visual Graph (Simple Bar for now) -->
        <div class="w-32 h-32 bg-gray-700 rounded-full flex items-center justify-center">
            <canvas id="heartRateChart" width="120" height="120"></canvas>
        </div>
    </div>

    <!-- Volume vs. Heart Rate Correlation -->
    <div class="mt-6 text-center">
        <p id="volume-heart-correlation" class="text-gray-300">Volume: --%</p>
        <p id="genre-effect" class="text-sm text-gray-400">Género: -- | Efeito: --</p>
    </div>
</div>


</body>
    <script>
        $(document).ready(function() {

        // Elementos da página
        const progressBar = document.getElementById("progress-bar");
        const currentTimeLabel = document.getElementById("current-time");
        const totalTimeLabel = document.getElementById("total-time");
        const songTitleElement = document.getElementById("song-title"); // <h3 id="song-title">
        const albumCover = document.getElementById("album-cover");
        const heartRateValueElement = $("#heart-rate-value");
        const volumeCorrelationElement = $("#volume-heart-correlation");
        const genreEffectElement = $("#genre-effect");

        // A session key é passada pelo Django via template
        const userKey = "{{ user_key }}";

        // Função para formatar milissegundos para mm:ss
        function formatTime(ms) {
            const minutes = Math.floor(ms / 60000);
            const seconds = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
            return `${minutes}:${seconds}`;
        }

        // Função para atualizar a UI com os dados sincronizados
        function fetchSyncedData() {
            fetch(`/spotify/api/synced-data/?session_key=${userKey}`, {
                method: "GET",
                headers: { "X-Requested-With": "XMLHttpRequest" },
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // Atualiza informações da música e ritmo cardíaco

                    // Atualiza o título da música e artista se mudou
                    if (data.musica && songTitleElement) {
                        songTitleElement.textContent = `${data.musica} - ${data.artista}`;
                    }

                    // Atualiza a imagem do álbum
                    if (data.album_cover && albumCover) {
                        albumCover.src = data.album_cover;
                    }

                    // Atualiza a progress bar se os dados de tempo estiverem disponíveis
                    if (data.duration && typeof data.time !== "undefined") {
                        progressBar.max = data.duration;
                        progressBar.value = data.time;
                        currentTimeLabel.textContent = formatTime(data.time);
                        totalTimeLabel.textContent = formatTime(data.duration);
                    }

                    // Atualiza o valor do heart rate
                    if (data.ritmo_cardiaco) {
                        heartRateValueElement.text(`${data.ritmo_cardiaco} BPM`);
                        // Ajusta a velocidade da animação do coração (pulse) com base no BPM
                        const pulseSpeed = Math.max(500, 2000 - (data.ritmo_cardiaco * 10));
                        $("#heart-icon").css("animation-duration", `${pulseSpeed}ms`);
                    }

                    // Atualiza a correlação de volume/decibéis, se esses dados estiverem presentes
                    if (data.volume) {
                        volumeCorrelationElement.text(`Volume: ${data.volume || "--"}% | Decibéis: ${data.decibeis_musica} dB`);
                    }

                    // Atualiza o gênero e efeito (exemplo)
                    if (data.genero) {
                        const genStr = Array.isArray(data.genero) && data.genero.length > 0 ? data.genero.join(", ") : "--";
                        // Determina o efeito com base no ritmo cardíaco
                        let efeito;
                        if (data.ritmo_cardiaco > 80) {
                            efeito = "Estimulante";
                        } else if (data.ritmo_cardiaco >= 65 && data.ritmo_cardiaco <= 79) {
                            efeito = "Normal";
                        } else {
                            efeito = "Calmante";
                        }

                        // Atualiza o texto do elemento
                        genreEffectElement.text(`Género: ${genStr} | Efeito: ${efeito}`);
                    }
                })
                .catch(error => {
                    console.error("Erro ao buscar dados sincronizados:", error);
                });
        }

        // Atualiza a progress bar e demais dados a cada 10 segundos
        setInterval(fetchSyncedData, 2000);


        // Exemplo de integração com controle (mantém os botões inalterados):
       // Skip Button
        // Skip Button
            $("#skip-btn").click(function() {
                var key = "{{ user_key }}";  // Pass the key value from the template

                $.ajax({
                    url: "/spotify/controls/",  // URL for skip action
                    type: "POST",
                    data: {
                        key: key,
                        action: "skip",  // Add action for skipping to next song
                    },
                    success: function(response) {
                        console.log("Skipped to next song:", response);
                        // Optionally update UI to reflect the new song
                    },
                    error: function(response) {
                        console.error("Skip action failed:", response);
                    }
                });
            });


        // Previous Button
        $("#previous-btn").click(function() {
            $.ajax({
                url: "/spotify/controls/",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    key: userKey,
                    action: "previous"
                }),
                dataType: "json",
                success: function(response) {
                    console.log("Went to previous song:", response);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Previous action failed:", textStatus, errorThrown, jqXHR.responseText);
                }
            });
        });

        // Play/Pause Button
        $("#play-pause-btn").click(function() {
            var action = $(this).data("action");
            $.ajax({
                url: "/spotify/controls/",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    key: userKey,
                    action: action
                }),
                dataType: "json",
                success: function(response) {
                    console.log("Action successful:", response);
                    if (action === "resume") {
                        $("#play-pause-btn").data("action", "stop").text("Pause");
                    } else {
                        $("#play-pause-btn").data("action", "resume").text("Play");
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Action failed:", textStatus, errorThrown, jqXHR.responseText);
                }
            });
        });

        // Stop Button
        $("#stop-btn").click(function() {
            $.ajax({
                url: "/spotify/controls/",
                method: "POST",
                contentType: "application/json",
                data: JSON.stringify({
                    key: userKey,
                    action: "stop"
                }),
                dataType: "json",
                success: function(response) {
                    console.log("Action successful:", response);
                    $("#stop-btn").prop("disabled", true);
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.error("Action failed:", textStatus, errorThrown, jqXHR.responseText);
                }
            });
        });



            // Heart Rate Real-Time Updates
            let heartRateHistory = [];
            const MAX_HISTORY = 20; // Keep last 20 readings for the chart

            function updateHeartRate(bpm) {
                // Update BPM Text
                $("#heart-rate-value").text(`${bpm} BPM`);

                // Adjust heart icon pulse speed based on BPM (faster for higher BPM)
                const pulseSpeed = Math.max(500, 2000 - (bpm * 10));
                $("#heart-icon").css("animation-duration", `${pulseSpeed}ms`);

                // Store data for chart
                heartRateHistory.push(bpm);
                if (heartRateHistory.length > MAX_HISTORY) {
                    heartRateHistory.shift();
                }

                updateHeartRateChart();
            }

            // Chart.js for Heart Rate Visualization
            let heartRateChart = null;
            function updateHeartRateChart() {
                const ctx = document.getElementById('heartRateChart').getContext('2d');

                if (heartRateChart) {
                    heartRateChart.destroy();
                }

                heartRateChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: Array(heartRateHistory.length).fill(''),
                        datasets: [{
                            label: 'Heart Rate',
                            data: heartRateHistory,
                            borderColor: '#ef4444', // Tailwind red-500
                            tension: 0.4,
                            fill: false,
                            pointRadius: 0
                        }]
                    },
                    options: {
                        responsive: false,
                        scales: {
                            y: {
                                min: Math.max(40, Math.min(...heartRateHistory) - 10),
                                max: Math.min(180, Math.max(...heartRateHistory) + 10)
                            }
                        },
                        plugins: {
                            legend: { display: false }
                        }
                    }
                });
            }
        }

            );
    </script>

    <style>
        /* Tailwind Custom continuous animation for fast spinning */
        @keyframes spin-fast {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        /* Apply the animation */
        .animate-spin-fast {
            animation: spin-fast 7s linear infinite; /* time to do a whole spin */
        }

        /* Heart Pulse Animation */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.3); }
            100% { transform: scale(1); }
        }

        .animate-pulse {
            animation: pulse 1.5s infinite;
        }

        /* Chart Container Styling */
        #heartRateChart {
            background-color: rgba(55, 65, 81, 0.5); /* bg-gray-700 with opacity */
            border-radius: 50%;
            padding: 8px;
        }
    </style>


</html>
